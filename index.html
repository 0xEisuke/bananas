<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒãƒŠãƒŠã‚¹ã‚¹ãƒ­ãƒƒãƒˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
      background: #fffde7;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .game-wrapper {
      position: relative;
      width: 100%;
      max-width: 480px;
      padding: 24px 16px 32px;
      background: #fffef3;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      text-align: center;
      overflow: hidden;
    }
    h1 {
      margin: 0 0 12px;
      font-size: 22px;
    }
    .subtitle {
      font-size: 13px;
      color: #666;
      margin-bottom: 16px;
    }
    .slots {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin: 8px 0 16px;
    }
    .slot {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      transition: transform 0.15s ease, color 0.15s ease, text-shadow 0.15s ease;
    }

    /* å›è»¢ä¸­ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .slot.spinning {
      animation: spinSlot 0.4s linear infinite;
      opacity: 0.9;
    }
    @keyframes spinSlot {
      0%   { transform: translateY(0) scale(1); }
      25%  { transform: translateY(-5px) scale(1.05); }
      50%  { transform: translateY(0) scale(1); }
      75%  { transform: translateY(5px) scale(1.05); }
      100% { transform: translateY(0) scale(1); }
    }

    .result {
      min-height: 40px;
      margin-bottom: 16px;
    }
    .result-text {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 4px;
    }
    .result-emoji {
      font-size: 28px;
    }
    .btn-spin {
      display: inline-block;
      border: none;
      border-radius: 999px;
      padding: 10px 28px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, #ffeb3b, #ffc107);
      box-shadow: 0 3px 0 #f9a825;
      transition: transform 0.05s ease, box-shadow 0.05s ease, opacity 0.1s ease;
    }
    .btn-spin:active {
      transform: translateY(2px);
      box-shadow: 0 1px 0 #f9a825;
    }
    .btn-spin:disabled {
      opacity: 0.5;
      cursor: default;
      transform: none;
      box-shadow: 0 3px 0 #f9a825;
    }

    /* ğŸ† ãƒŠã‚¹ãƒ’ãƒƒãƒˆ */
    .hit-nasu {
      color: #7b1fa2;
      text-shadow: 0 0 8px rgba(123, 31, 162, 0.7);
    }
    /* ğŸŒ ãƒãƒŠãƒŠãƒ’ãƒƒãƒˆ */
    .hit-banana {
      color: #fbc02d;
      text-shadow: 0 0 8px rgba(251, 192, 45, 0.9);
    }
    /* ğŸŒğŸ† ãƒãƒŠãƒŠã‚¹ãƒ’ãƒƒãƒˆï¼ˆå…¨éƒ¨ï¼‰ */
    .hit-bananas {
      color: #ff5722;
      text-shadow: 0 0 10px rgba(255, 87, 34, 0.9);
      transform: scale(1.15);
    }

    /* ğŸŒğŸ† é™ã£ã¦ãã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    #emoji-rain-container {
      pointer-events: none;
      position: absolute;
      inset: 0;
      overflow: hidden;
      z-index: 10;
    }
    .emoji-drop {
      position: absolute;
      top: -10%;
      font-size: 24px;
      animation: fall linear forwards;
    }
    @keyframes fall {
      0% {
        transform: translateY(-100%);
        opacity: 1;
      }
      100% {
        transform: translateY(120vh);
        opacity: 0;
      }
    }

    /* ãƒãƒŠãƒŠã®ãƒŠã‚¹ã€ãƒãƒŠãƒŠã‚¹ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;           /* æœ€åˆã¯éš ã™ */
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .dialog {
      background: #fff;
      border-radius: 12px;
      min-width: 260px;
      max-width: 80%;
      text-align: center;
      overflow: hidden;
      box-shadow: 0 4px 16px rgba(0,0,0,0.35);
    }
    .dialog-message {
      padding: 18px 16px 14px;
      font-size: 16px;
    }
    .dialog-button {
      border-top: 1px solid #ddd;
      padding: 10px 0;
      color: #007aff;
      font-size: 17px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div class="game-wrapper">
  <h1>ãƒãƒŠãƒŠã‚¹ã‚¹ãƒ­ãƒƒãƒˆ ğŸŒğŸ†</h1>
  <div class="subtitle">ãƒãƒ»ãƒŠãƒ»ã‚¹ ã®4æ–‡å­—ã‚¹ãƒ­ãƒƒãƒˆã€‚ãƒãƒŠãƒŠã‚¹ãŒå‡ºã‚‹ã¨â€¦ï¼Ÿ</div>

  <div class="slots">
    <div class="slot" id="slot0">ãƒ</div>
    <div class="slot" id="slot1">ãƒŠ</div>
    <div class="slot" id="slot2">ãƒŠ</div>
    <div class="slot" id="slot3">ã‚¹</div>
  </div>

  <div class="result">
    <div class="result-text" id="result-text">ãƒãƒŠãƒŠã‚¹ã‚’ç‹™ãˆï¼</div>
    <div class="result-emoji" id="result-emoji">ğŸŒğŸ†</div>
  </div>

  <button class="btn-spin" id="spin-btn">å›ã™ï¼</button>

  <!-- ğŸŒğŸ† ãŒé™ã£ã¦ãã‚‹ã‚³ãƒ³ãƒ†ãƒŠ -->
  <div id="emoji-rain-container"></div>
</div>

<!-- ãƒãƒŠãƒŠã®ãƒŠã‚¹ã€ãƒãƒŠãƒŠã‚¹ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
<div class="overlay" id="banana-popup">
  <div class="dialog">
    <div class="dialog-message">ãƒãƒŠãƒŠã®ãƒŠã‚¹ã€ãƒãƒŠãƒŠã‚¹</div>
    <div class="dialog-button" id="popup-ok-btn">äº†è§£</div>
  </div>
</div>

<!-- åŠ¹æœéŸ³ï¼ˆåŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã« mp3 ã‚’ç½®ãï¼‰ -->
<audio id="se-nasu" src="nasu.mp3" preload="auto"></audio>
<audio id="se-banana" src="banana.mp3" preload="auto"></audio>
<audio id="se-bananas" src="bananas.mp3" preload="auto"></audio>

<script>
  const CHARS = ["ãƒ", "ãƒŠ", "ã‚¹"];
  const slots = [
    document.getElementById("slot0"),
    document.getElementById("slot1"),
    document.getElementById("slot2"),
    document.getElementById("slot3"),
  ];
  const resultTextEl = document.getElementById("result-text");
  const resultEmojiEl = document.getElementById("result-emoji");
  const spinBtn = document.getElementById("spin-btn");

  const rainContainer = document.getElementById("emoji-rain-container");

  const popup = document.getElementById("banana-popup");
  const popupOkBtn = document.getElementById("popup-ok-btn");

  // åŠ¹æœéŸ³
  const seNasu = document.getElementById("se-nasu");
  const seBanana = document.getElementById("se-banana");
  const seBananas = document.getElementById("se-bananas");

  let isSpinning = false;

  popupOkBtn.addEventListener("click", () => {
    popup.style.display = "none";
  });

  function setResult(text, emoji) {
    resultTextEl.textContent = text;
    resultEmojiEl.textContent = emoji;
  }

  function playSound(audioEl) {
    if (!audioEl) return;
    try {
      audioEl.currentTime = 0;
      audioEl.play();
    } catch (e) {
      // ãƒ¢ãƒã‚¤ãƒ«ã®è‡ªå‹•å†ç”Ÿåˆ¶é™ãªã©ã§å¤±æ•—ã™ã‚‹ã“ã¨ã‚‚ã‚ã‚‹ã®ã§ç„¡è¦–
    }
  }

  // ğŸŒğŸ† é™ã‚‰ã›ã‚‹
  function startEmojiRain(type) {
    const count = 40;
    const emojis =
      type === "nasu" ? ["ğŸ†"] :
      type === "banana" ? ["ğŸŒ"] :
      ["ğŸŒ", "ğŸ†"];

    for (let i = 0; i < count; i++) {
      const span = document.createElement("span");
      span.className = "emoji-drop";
      span.textContent = emojis[Math.floor(Math.random() * emojis.length)];
      span.style.left = Math.random() * 100 + "%";
      const duration = 2.5 + Math.random() * 1.5;
      const delay = Math.random() * 0.8;
      span.style.animationDuration = duration + "s";
      span.style.animationDelay = delay + "s";
      rainContainer.appendChild(span);
      span.addEventListener("animationend", () => {
        span.remove();
      });
    }
  }

  function clearEmojiRain() {
    while (rainContainer.firstChild) {
      rainContainer.removeChild(rainContainer.firstChild);
    }
  }

  function clearHighlights() {
    slots.forEach(slot => {
      slot.classList.remove("hit-nasu", "hit-banana", "hit-bananas");
    });
  }

  function highlight(indices, className) {
    clearHighlights();
    indices.forEach(idx => {
      if (slots[idx]) {
        slots[idx].classList.add(className);
      }
    });
  }

  function findIndices(result, pattern) {
    const indicesSet = new Set();
    let start = 0;
    while (true) {
      const idx = result.indexOf(pattern, start);
      if (idx === -1) break;
      for (let i = 0; i < pattern.length; i++) {
        indicesSet.add(idx + i);
      }
      start = idx + 1;
    }
    return Array.from(indicesSet.values()).sort();
  }

  // ã‚¹ãƒ­ãƒƒãƒˆã‚’å›ã™ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãï¼‰
  function spin() {
    if (isSpinning) return;
    isSpinning = true;
    spinBtn.disabled = true;

    clearEmojiRain();
    popup.style.display = "none";
    clearHighlights();
    setResult("â€¦â€¦", "");

    // å›è»¢é–‹å§‹
    slots.forEach(slot => slot.classList.add("spinning"));

    const spinDuration = 900; // å…¨ä½“ã®å›è»¢æ™‚é–“(ms)
    const interval = 80;      // ãƒ©ãƒ³ãƒ€ãƒ æ›¸ãæ›ãˆé–“éš”(ms)
    let elapsed = 0;

    const spinTimer = setInterval(() => {
      elapsed += interval;

      // å›è»¢ä¸­ã¯ãƒ©ãƒ³ãƒ€ãƒ æ–‡å­—ã‚’è¡¨ç¤º
      for (let i = 0; i < 4; i++) {
        const ch = CHARS[Math.floor(Math.random() * CHARS.length)];
        slots[i].textContent = ch;
      }

      if (elapsed >= spinDuration) {
        clearInterval(spinTimer);

        // æœ€çµ‚çµæœã‚’æ±ºå®š
        let result = "";
        for (let i = 0; i < 4; i++) {
          const ch = CHARS[Math.floor(Math.random() * CHARS.length)];
          slots[i].textContent = ch;
          result += ch;
        }

        // å›è»¢åœæ­¢
        slots.forEach(slot => slot.classList.remove("spinning"));

        // åˆ¤å®šã¸
        judgeResult(result);

        spinBtn.disabled = false;
        isSpinning = false;
      }
    }, interval);
  }

  // å½¹åˆ¤å®š
  function judgeResult(result) {
    clearHighlights();

    const nasuIndices = findIndices(result, "ãƒŠã‚¹");
    const bananaIndices = findIndices(result, "ãƒãƒŠãƒŠ");
    const bananasIndices = (result === "ãƒãƒŠãƒŠã‚¹") ? [0, 1, 2, 3] : [];

    const hasNasu = nasuIndices.length > 0;
    const hasBanana = bananaIndices.length > 0;
    const isBananas = (result === "ãƒãƒŠãƒŠã‚¹");

    clearEmojiRain();

    if (isBananas) {
      // è¡¨ç¤ºé †ï¼šãƒŠã‚¹ â†’ ãƒãƒŠãƒŠ â†’ ãƒãƒŠãƒŠã‚¹
      highlight(nasuIndices, "hit-nasu");
      setResult("ãƒŠã‚¹ï¼", "ğŸ†");
      startEmojiRain("nasu");
      playSound(seNasu);

      setTimeout(() => {
        highlight(bananaIndices, "hit-banana");
        setResult("ãƒãƒŠãƒŠï¼", "ğŸŒ");
        startEmojiRain("banana");
        playSound(seBanana);
      }, 700);

      setTimeout(() => {
        highlight(bananasIndices, "hit-bananas");
        setResult("ãƒãƒŠãƒŠã‚¹ï¼ï¼ï¼", "ğŸŒğŸ†");
        startEmojiRain("both");
        playSound(seBananas);
        popup.style.display = "flex";
      }, 1400);

    } else if (hasBanana) {
      highlight(bananaIndices, "hit-banana");
      setResult("ãƒãƒŠãƒŠï¼", "ğŸŒ");
      startEmojiRain("banana");
      playSound(seBanana);

    } else if (hasNasu) {
      highlight(nasuIndices, "hit-nasu");
      setResult("ãƒŠã‚¹ï¼", "ğŸ†");
      startEmojiRain("nasu");
      playSound(seNasu);

    } else {
      setResult("ãƒã‚ºãƒ¬â€¦", "ğŸ¥²");
    }
  }

  spinBtn.addEventListener("click", spin);
</script>

</body>
</html>
