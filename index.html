<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒãƒŠãƒŠã‚¹ã‚¹ãƒ­ãƒƒãƒˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
      background: #fffde7;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .game-wrapper {
      position: relative;
      width: 100%;
      max-width: 520px;
      padding: 20px 14px 28px;
      background: #fffef3;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      text-align: center;
      overflow: hidden;
    }
    h1 {
      margin: 0 0 6px;
      font-size: 22px;
    }
    .subtitle {
      font-size: 13px;
      color: #666;
      margin-bottom: 10px;
    }

    .status {
      display: flex;
      justify-content: center;
      gap: 10px;
      font-size: 13px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    .status span {
      padding: 3px 9px;
      border-radius: 999px;
      background: #fff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }

    .slots {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin: 8px 0 14px;
    }
    .slot {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      transition: transform 0.15s ease, color 0.15s ease, text-shadow 0.15s ease;
    }

    /* å›è»¢ä¸­ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .slot.spinning {
      animation: spinSlot 0.4s linear infinite;
      opacity: 0.9;
    }
    @keyframes spinSlot {
      0%   { transform: translateY(0) scale(1); }
      25%  { transform: translateY(-5px) scale(1.05); }
      50%  { transform: translateY(0) scale(1); }
      75%  { transform: translateY(5px) scale(1.05); }
      100% { transform: translateY(0) scale(1); }
    }

    .result {
      min-height: 38px;
      margin-bottom: 12px;
    }
    .result-text {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 4px;
    }
    .result-emoji {
      font-size: 24px;
    }
    .btn-spin {
      display: inline-block;
      border: none;
      border-radius: 999px;
      padding: 9px 26px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, #ffeb3b, #ffc107);
      box-shadow: 0 3px 0 #f9a825;
      transition: transform 0.05s ease, box-shadow 0.05s ease, opacity 0.1s ease;
      margin-bottom: 10px;
    }
    .btn-spin:active {
      transform: translateY(2px);
      box-shadow: 0 1px 0 #f9a825;
    }
    .btn-spin:disabled {
      opacity: 0.5;
      cursor: default;
      transform: none;
      box-shadow: 0 3px 0 #f9a825;
    }

    /* ãƒ’ãƒƒãƒˆæ™‚ã®è‰² */
    .hit-nasu {
      color: #7b1fa2;
      text-shadow: 0 0 8px rgba(123, 31, 162, 0.7);
    }
    .hit-banana {
      color: #fbc02d;
      text-shadow: 0 0 8px rgba(251, 192, 45, 0.9);
    }
    .hit-bananas {
      color: #ff5722;
      text-shadow: 0 0 10px rgba(255, 87, 34, 0.9);
      transform: scale(1.15);
    }

    /* ğŸŒğŸ† é™ã£ã¦ãã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    #emoji-rain-container {
      pointer-events: none;
      position: absolute;
      inset: 0;
      overflow: hidden;
      z-index: 10;
    }
    .emoji-drop {
      position: absolute;
      top: -10%;
      font-size: 24px;
      animation: fall linear forwards;
    }
    @keyframes fall {
      0% {
        transform: translateY(-100%);
        opacity: 1;
      }
      100% {
        transform: translateY(120vh);
        opacity: 0;
      }
    }

    /* ãƒãƒŠãƒŠã®ãƒŠã‚¹ã€ãƒãƒŠãƒŠã‚¹ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .dialog {
      background: #fff;
      border-radius: 12px;
      min-width: 260px;
      max-width: 80%;
      text-align: center;
      overflow: hidden;
      box-shadow: 0 4px 16px rgba(0,0,0,0.35);
    }
    .dialog-message {
      padding: 18px 16px 14px;
      font-size: 16px;
    }
    .dialog-button {
      border-top: 1px solid #ddd;
      padding: 10px 0;
      color: #007aff;
      font-size: 17px;
      cursor: pointer;
    }

    /* è‚²æˆUI */
    .upgrades {
      margin-top: 8px;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px;
      font-size: 12px;
    }
    .upgrade-card {
      background: #fff;
      border-radius: 10px;
      padding: 6px 8px 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      text-align: left;
    }
    .upgrade-title {
      font-weight: 600;
      margin-bottom: 2px;
      font-size: 12px;
    }
    .upgrade-info {
      font-size: 11px;
      color: #555;
      margin-bottom: 4px;
    }
    .upgrade-btn {
      border: none;
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 11px;
      cursor: pointer;
      background: #e3f2fd;
      color: #0d47a1;
      width: 100%;
    }
    .upgrade-btn:disabled {
      opacity: 0.5;
      cursor: default;
    }
  </style>
</head>
<body>

<div class="game-wrapper">
  <h1>ãƒãƒŠãƒŠã‚¹ã‚¹ãƒ­ãƒƒãƒˆ ğŸŒğŸ†</h1>
  <div class="subtitle">ãƒã‚¤ãƒ³ãƒˆã¨ã‚¢ã‚¤ãƒ†ãƒ ã§è‚²æˆã—ãªãŒã‚‰ã€ãƒãƒŠãƒŠã‚¹ã‚’ç‹™ãˆï¼</div>

  <div class="status">
    <span id="point-display">ãƒã‚¤ãƒ³ãƒˆ: 100</span>
    <span id="banana-display">ğŸŒ: 0</span>
    <span id="eggplant-display">ğŸ†: 0</span>
  </div>

  <div class="slots">
    <div class="slot" id="slot0">ãƒ</div>
    <div class="slot" id="slot1">ãƒŠ</div>
    <div class="slot" id="slot2">ãƒŠ</div>
    <div class="slot" id="slot3">ã‚¹</div>
  </div>

  <div class="result">
    <div class="result-text" id="result-text">ãƒãƒŠãƒŠã‚¹ã‚’ç‹™ãˆï¼</div>
    <div class="result-emoji" id="result-emoji">ğŸŒğŸ†</div>
  </div>

  <button class="btn-spin" id="spin-btn">10 pt ã§å›ã™ï¼</button>

  <!-- ğŸŒğŸ† ãŒé™ã£ã¦ãã‚‹ã‚³ãƒ³ãƒ†ãƒŠ -->
  <div id="emoji-rain-container"></div>

  <!-- è‚²æˆUI -->
  <div class="upgrades">
    <div class="upgrade-card">
      <div class="upgrade-title">ğŸŒ 1ã‚¹ãƒ­ãƒƒãƒˆç›®ã€Œãƒã€ç¢ºç‡UP</div>
      <div class="upgrade-info" id="prob-b-info">Lv.0ï¼ˆ33%+0%ï¼‰</div>
      <button class="upgrade-btn" id="upgrade-prob-b-btn">ğŸŒx1ã§å¼·åŒ–ï¼ˆ+3%ï¼‰</button>
    </div>
    <div class="upgrade-card">
      <div class="upgrade-title">ğŸ† 4ã‚¹ãƒ­ãƒƒãƒˆç›®ã€Œã‚¹ã€ç¢ºç‡UP</div>
      <div class="upgrade-info" id="prob-s-info">Lv.0ï¼ˆ33%+0%ï¼‰</div>
      <button class="upgrade-btn" id="upgrade-prob-s-btn">ğŸ†x1ã§å¼·åŒ–ï¼ˆ+3%ï¼‰</button>
    </div>
    <div class="upgrade-card">
      <div class="upgrade-title">å€ç‡UPï¼šãƒãƒŠãƒŠã‚¹</div>
      <div class="upgrade-info">Lv.<span id="multi-bananas-level">0</span> å€ç‡x<span id="multi-bananas-factor">1.0</span></div>
      <button class="upgrade-btn" id="upgrade-multi-bananas-btn">ğŸŒx2ğŸ†x2ã§å¼·åŒ–</button>
    </div>
    <div class="upgrade-card">
      <div class="upgrade-title">å€ç‡UPï¼šWãƒãƒŠãƒŠ</div>
      <div class="upgrade-info">Lv.<span id="multi-wbanana-level">0</span> å€ç‡x<span id="multi-wbanana-factor">1.0</span></div>
      <button class="upgrade-btn" id="upgrade-multi-wbanana-btn">ğŸŒx2ã§å¼·åŒ–</button>
    </div>
    <div class="upgrade-card">
      <div class="upgrade-title">å€ç‡UPï¼šWãƒŠã‚¹</div>
      <div class="upgrade-info">Lv.<span id="multi-wnasu-level">0</span> å€ç‡x<span id="multi-wnasu-factor">1.0</span></div>
      <button class="upgrade-btn" id="upgrade-multi-wnasu-btn">ğŸ†x2ã§å¼·åŒ–</button>
    </div>
    <div class="upgrade-card">
      <div class="upgrade-title">å€ç‡UPï¼šãƒãƒŠãƒŠ</div>
      <div class="upgrade-info">Lv.<span id="multi-banana-level">0</span> å€ç‡x<span id="multi-banana-factor">1.0</span></div>
      <button class="upgrade-btn" id="upgrade-multi-banana-btn">ğŸŒx1ã§å¼·åŒ–</button>
    </div>
    <div class="upgrade-card">
      <div class="upgrade-title">å€ç‡UPï¼šãƒŠã‚¹</div>
      <div class="upgrade-info">Lv.<span id="multi-nasu-level">0</span> å€ç‡x<span id="multi-nasu-factor">1.0</span></div>
      <button class="upgrade-btn" id="upgrade-multi-nasu-btn">ğŸ†x1ã§å¼·åŒ–</button>
    </div>
  </div>
</div>

<!-- ãƒãƒŠãƒŠã®ãƒŠã‚¹ã€ãƒãƒŠãƒŠã‚¹ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
<div class="overlay" id="banana-popup">
  <div class="dialog">
    <div class="dialog-message">ãƒãƒŠãƒŠã®ãƒŠã‚¹ã€ãƒãƒŠãƒŠã‚¹</div>
    <div class="dialog-button" id="popup-ok-btn">äº†è§£</div>
  </div>
</div>

<!-- åŠ¹æœéŸ³ï¼ˆåŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã« mp3 ã‚’ç½®ãï¼‰ -->
<audio id="se-nasu" src="nasu.mp3" preload="auto"></audio>
<audio id="se-banana" src="banana.mp3" preload="auto"></audio>
<audio id="se-bananas" src="bananas.mp3" preload="auto"></audio>

<script>
  const CHARS = ["ãƒ", "ãƒŠ", "ã‚¹"];
  const slots = [
    document.getElementById("slot0"),
    document.getElementById("slot1"),
    document.getElementById("slot2"),
    document.getElementById("slot3"),
  ];
  const resultTextEl = document.getElementById("result-text");
  const resultEmojiEl = document.getElementById("result-emoji");
  const spinBtn = document.getElementById("spin-btn");

  const pointDisplay = document.getElementById("point-display");
  const bananaDisplay = document.getElementById("banana-display");
  const eggplantDisplay = document.getElementById("eggplant-display");

  const rainContainer = document.getElementById("emoji-rain-container");

  const popup = document.getElementById("banana-popup");
  const popupOkBtn = document.getElementById("popup-ok-btn");

  // åŠ¹æœéŸ³
  const seNasu = document.getElementById("se-nasu");
  const seBanana = document.getElementById("se-banana");
  const seBananas = document.getElementById("se-bananas");

  let isSpinning = false;
  let points = 100;      // åˆæœŸãƒã‚¤ãƒ³ãƒˆ
  let freeSpins = 0;     // ç„¡æ–™ã‚¹ãƒ”ãƒ³

  let bananas = 0;       // ğŸŒæ‰€æŒæ•°
  let eggplants = 0;     // ğŸ†æ‰€æŒæ•°

  let lastWasBananas = false;  // ç›´è¿‘ã®çµæœãŒãƒãƒŠãƒŠã‚¹ã ã£ãŸã‹ã©ã†ã‹


  // ç¢ºç‡ã‚¢ãƒƒãƒ—Lv
  let probBLevel = 0;    // slot0ã€Œãƒã€
  let probSLevel = 0;    // slot3ã€Œã‚¹ã€
  const maxProbLevel = 10;
  const fibCosts = [1,1,2,3,5,8,13,21,34,55]; // f(0)ã€œf(9) çš„ã«ä½¿ã†

  // å½¹ã”ã¨ã®å€ç‡Lvï¼ˆx1,1.5,2,...ï¼‰
  let multiBananasLv = 0;  // ãƒãƒŠãƒŠã‚¹
  let multiWBananaLv = 0;  // WãƒãƒŠãƒŠ
  let multiWNasuLv = 0;    // WãƒŠã‚¹
  let multiBananaLv = 0;   // ãƒãƒŠãƒŠ
  let multiNasuLv = 0;     // ãƒŠã‚¹
  const maxMultiLevel = 10;

  // è‚²æˆUIè¦ç´ 
  const probBInfoEl = document.getElementById("prob-b-info");
  const probSInfoEl = document.getElementById("prob-s-info");
  const upgradeProbBBtn = document.getElementById("upgrade-prob-b-btn");
  const upgradeProbSBtn = document.getElementById("upgrade-prob-s-btn");

  const multiBananasLevelEl = document.getElementById("multi-bananas-level");
  const multiWBananaLevelEl = document.getElementById("multi-wbanana-level");
  const multiWNasuLevelEl = document.getElementById("multi-wnasu-level");
  const multiBananaLevelEl = document.getElementById("multi-banana-level");
  const multiNasuLevelEl = document.getElementById("multi-nasu-level");

  const multiBananasFactorEl = document.getElementById("multi-bananas-factor");
  const multiWBananaFactorEl = document.getElementById("multi-wbanana-factor");
  const multiWNasuFactorEl = document.getElementById("multi-wnasu-factor");
  const multiBananaFactorEl = document.getElementById("multi-banana-factor");
  const multiNasuFactorEl = document.getElementById("multi-nasu-factor");

  const upgradeMultiBananasBtn = document.getElementById("upgrade-multi-bananas-btn");
  const upgradeMultiWBananaBtn = document.getElementById("upgrade-multi-wbanana-btn");
  const upgradeMultiWNasuBtn = document.getElementById("upgrade-multi-wnasu-btn");
  const upgradeMultiBananaBtn = document.getElementById("upgrade-multi-banana-btn");
  const upgradeMultiNasuBtn = document.getElementById("upgrade-multi-nasu-btn");

  function getMultiplier(level) {
    return 1 + 0.5 * level;
  }

  function updateStatus() {
    pointDisplay.textContent = `ãƒã‚¤ãƒ³ãƒˆ: ${points}`;
    bananaDisplay.textContent = `ğŸŒ: ${bananas}`;
    eggplantDisplay.textContent = `ğŸ†: ${eggplants}`;

    // ã‚¹ãƒ”ãƒ³ãƒœã‚¿ãƒ³è¡¨è¨˜
    if (freeSpins > 0) {
      spinBtn.textContent = `ç„¡æ–™ã‚¹ãƒ”ãƒ³: ${freeSpins} ã§å›ã™`;
    } else {
      spinBtn.textContent = `10 pt ã§å›ã™ï¼`;
    }

    // ç¢ºç‡UPè¡¨è¨˜ï¼ˆLv.nï¼ˆ33%+3n%ï¼‰ï¼‰
    const basePercent = 33;
    probBInfoEl.textContent = `Lv.${probBLevel}ï¼ˆ${basePercent}%+${probBLevel * 3}%ï¼‰`;
    probSInfoEl.textContent = `Lv.${probSLevel}ï¼ˆ${basePercent}%+${probSLevel * 3}%ï¼‰`;

    // å€ç‡è¡¨ç¤º
    multiBananasLevelEl.textContent = multiBananasLv;
    multiWBananaLevelEl.textContent = multiWBananaLv;
    multiWNasuLevelEl.textContent = multiWNasuLv;
    multiBananaLevelEl.textContent = multiBananaLv;
    multiNasuLevelEl.textContent = multiNasuLv;

    multiBananasFactorEl.textContent = getMultiplier(multiBananasLv).toFixed(1);
    multiWBananaFactorEl.textContent = getMultiplier(multiWBananaLv).toFixed(1);
    multiWNasuFactorEl.textContent = getMultiplier(multiWNasuLv).toFixed(1);
    multiBananaFactorEl.textContent = getMultiplier(multiBananaLv).toFixed(1);
    multiNasuFactorEl.textContent = getMultiplier(multiNasuLv).toFixed(1);

    // ç¢ºç‡UPãƒœã‚¿ãƒ³ï¼ˆMAXåˆ¤å®šï¼†è¡¨è¨˜ï¼‰
    if (probBLevel >= maxProbLevel) {
      upgradeProbBBtn.textContent = "Lv MAX";
      upgradeProbBBtn.disabled = true;
    } else {
      const cost = fibCosts[probBLevel];
      upgradeProbBBtn.textContent = `ğŸŒx${cost}ã§å¼·åŒ–ï¼ˆ+3%ï¼‰`;
      upgradeProbBBtn.disabled = false;
    }
    if (probSLevel >= maxProbLevel) {
      upgradeProbSBtn.textContent = "Lv MAX";
      upgradeProbSBtn.disabled = true;
    } else {
      const cost = fibCosts[probSLevel];
      upgradeProbSBtn.textContent = `ğŸ†x${cost}ã§å¼·åŒ–ï¼ˆ+3%ï¼‰`;
      upgradeProbSBtn.disabled = false;
    }

    // å€ç‡UPãƒœã‚¿ãƒ³ï¼ˆã‚³ã‚¹ãƒˆè¡¨è¨˜ + MAXåˆ¤å®šï¼‰
    if (multiBananasLv >= maxMultiLevel) {
      upgradeMultiBananasBtn.textContent = "Lv MAX";
      upgradeMultiBananasBtn.disabled = true;
    } else {
      const f = fibCosts[multiBananasLv];
      upgradeMultiBananasBtn.textContent = `ğŸŒx${2 * f}ğŸ†x${2 * f}ã§å¼·åŒ–`;
      upgradeMultiBananasBtn.disabled = false;
    }

    if (multiWBananaLv >= maxMultiLevel) {
      upgradeMultiWBananaBtn.textContent = "Lv MAX";
      upgradeMultiWBananaBtn.disabled = true;
    } else {
      const f = fibCosts[multiWBananaLv];
      upgradeMultiWBananaBtn.textContent = `ğŸŒx${2 * f}ã§å¼·åŒ–`;
      upgradeMultiWBananaBtn.disabled = false;
    }

    if (multiWNasuLv >= maxMultiLevel) {
      upgradeMultiWNasuBtn.textContent = "Lv MAX";
      upgradeMultiWNasuBtn.disabled = true;
    } else {
      const f = fibCosts[multiWNasuLv];
      upgradeMultiWNasuBtn.textContent = `ğŸ†x${2 * f}ã§å¼·åŒ–`;
      upgradeMultiWNasuBtn.disabled = false;
    }

    if (multiBananaLv >= maxMultiLevel) {
      upgradeMultiBananaBtn.textContent = "Lv MAX";
      upgradeMultiBananaBtn.disabled = true;
    } else {
      const f = fibCosts[multiBananaLv];
      upgradeMultiBananaBtn.textContent = `ğŸŒx${f}ã§å¼·åŒ–`;
      upgradeMultiBananaBtn.disabled = false;
    }

    if (multiNasuLv >= maxMultiLevel) {
      upgradeMultiNasuBtn.textContent = "Lv MAX";
      upgradeMultiNasuBtn.disabled = true;
    } else {
      const f = fibCosts[multiNasuLv];
      upgradeMultiNasuBtn.textContent = `ğŸ†x${f}ã§å¼·åŒ–`;
      upgradeMultiNasuBtn.disabled = false;
    }
  }
  updateStatus();

  popupOkBtn.addEventListener("click", () => {
    popup.style.display = "none";
    // ãƒãƒŠãƒŠã‚¹ã®è¡¨ç¤ºã‚’è¦‹çµ‚ã‚ã£ã¦ã€Œäº†è§£ã€ã—ãŸã‚‰ã€æ¬¡ã«å›ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹
    spinBtn.disabled = false;
  });

  function setResult(text, emoji) {
    resultTextEl.textContent = text;
    resultEmojiEl.textContent = emoji;
  }

  function playSound(audioEl) {
    if (!audioEl) return;
    try {
      audioEl.currentTime = 0;
      audioEl.play();
    } catch (e) {
      // è‡ªå‹•å†ç”Ÿåˆ¶é™ãªã©ã§å¤±æ•—ã™ã‚‹ã“ã¨ã‚‚ã‚ã‚‹
    }
  }

  // ğŸŒğŸ† é™ã‚‰ã›ã‚‹
  function startEmojiRain(type) {
    const count = 40;
    const emojis =
      type === "nasu" ? ["ğŸ†"] :
      type === "banana" ? ["ğŸŒ"] :
      ["ğŸŒ", "ğŸ†"];

    for (let i = 0; i < count; i++) {
      const span = document.createElement("span");
      span.className = "emoji-drop";
      span.textContent = emojis[Math.floor(Math.random() * emojis.length)];
      span.style.left = Math.random() * 100 + "%";
      const duration = 2.5 + Math.random() * 1.5;
      const delay = Math.random() * 0.8;
      span.style.animationDuration = duration + "s";
      span.style.animationDelay = delay + "s";
      rainContainer.appendChild(span);
      span.addEventListener("animationend", () => {
        span.remove();
      });
    }
  }

  function clearEmojiRain() {
    while (rainContainer.firstChild) {
      rainContainer.removeChild(rainContainer.firstChild);
    }
  }

  function clearHighlights() {
    slots.forEach(slot => {
      slot.classList.remove("hit-nasu", "hit-banana", "hit-bananas");
      slot.style.transform = "";
    });
  }

  function highlight(indices, className) {
    clearHighlights();
    indices.forEach(idx => {
      if (slots[idx]) {
        slots[idx].classList.add(className);
      }
    });
  }

  function findIndices(result, pattern) {
    const indicesSet = new Set();
    let start = 0;
    while (true) {
      const idx = result.indexOf(pattern, start);
      if (idx === -1) break;
      for (let i = 0; i < pattern.length; i++) {
        indicesSet.add(idx + i);
      }
      start = idx + 1;
    }
    return Array.from(indicesSet.values()).sort();
  }

  // ã‚¹ãƒ­ãƒƒãƒˆã”ã¨ã®æ–‡å­—æŠ½é¸ï¼ˆç¢ºç‡èª¿æ•´å¯¾å¿œï¼‰
  function pickCharForSlot(slotIndex) {
    const r = Math.random();

    // slot0: ã€Œãƒã€ç¢ºç‡UP
    if (slotIndex === 0) {
      let pB = 1 / 3 + 0.03 * probBLevel;
      if (pB > 0.99) pB = 0.99;
      const remain = 1 - pB;
      const pN = remain / 2;
      if (r < pB) return "ãƒ";
      if (r < pB + pN) return "ãƒŠ";
      return "ã‚¹";
    }

    // slot3: ã€Œã‚¹ã€ç¢ºç‡UP
    if (slotIndex === 3) {
      let pS = 1 / 3 + 0.03 * probSLevel;
      if (pS > 0.99) pS = 0.99;
      const remain = 1 - pS;
      const pB = remain / 2;
      if (r < pB) return "ãƒ";
      if (r < pB + remain / 2) return "ãƒŠ";
      return "ã‚¹";
    }

    // ãã‚Œä»¥å¤–ã¯ç­‰ç¢ºç‡
    const idx = Math.floor(Math.random() * CHARS.length);
    return CHARS[idx];
  }

  // ã‚¹ãƒ­ãƒƒãƒˆã‚’å›ã™ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãï¼‰
  function spin() {
    if (isSpinning) return;

    // ã‚³ã‚¹ãƒˆå‡¦ç†
    if (freeSpins > 0) {
      freeSpins--;
    } else {
      if (points < 10) {
        setResult("ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šã¾ã›ã‚“â€¦", "ğŸ’¸");
        return;
      }
      points -= 10;
    }
    updateStatus();

    isSpinning = true;
    spinBtn.disabled = true;

    clearEmojiRain();
    popup.style.display = "none";
    clearHighlights();
    setResult("â€¦â€¦", "");

    // å›è»¢é–‹å§‹
    slots.forEach(slot => slot.classList.add("spinning"));

    const spinDuration = 900; // å…¨ä½“ã®å›è»¢æ™‚é–“(ms)
    const interval = 80;      // ãƒ©ãƒ³ãƒ€ãƒ æ›¸ãæ›ãˆé–“éš”(ms)
    let elapsed = 0;

    const spinTimer = setInterval(() => {
      elapsed += interval;

      // å›è»¢ä¸­ã¯ãƒ©ãƒ³ãƒ€ãƒ æ–‡å­—ã‚’è¡¨ç¤º
      for (let i = 0; i < 4; i++) {
        const ch = pickCharForSlot(i);
        slots[i].textContent = ch;
      }

      if (elapsed >= spinDuration) {
        clearInterval(spinTimer);

        // æœ€çµ‚çµæœã‚’æ±ºå®š
        let result = "";
        for (let i = 0; i < 4; i++) {
          const ch = pickCharForSlot(i);
          slots[i].textContent = ch;
          result += ch;
        }

        // å›è»¢åœæ­¢
        slots.forEach(slot => slot.classList.remove("spinning"));

        // åˆ¤å®šã¸
        judgeResult(result);

        // ãƒãƒŠãƒŠã‚¹ãŒå‡ºãŸå ´åˆã¯ã€ã€Œäº†è§£ã€ã‚’æŠ¼ã™ã¾ã§ã¯ã‚¹ãƒ”ãƒ³ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹ã«ã—ã¦ãŠã
        if (!lastWasBananas) {
            spinBtn.disabled = false;
        }
        isSpinning = false;
      }
    }, interval);
  }

  // å½¹åˆ¤å®š & å ±é…¬
  function judgeResult(result) {
    clearHighlights();

    const nasuIndices = findIndices(result, "ãƒŠã‚¹");
    const bananaIndices = findIndices(result, "ãƒãƒŠãƒŠ");

    const isBananas = (result === "ãƒãƒŠãƒŠã‚¹"); // ãƒãƒŠãƒŠã‚¹
    lastWasBananas = isBananas;
    const isWBanana = (result === "ãƒãƒŠãƒŠãƒ"); // WãƒãƒŠãƒŠ
    const isWNasu = (result === "ãƒŠã‚¹ãƒŠã‚¹");   // WãƒŠã‚¹
    const isFourSame =
      result[0] === result[1] &&
      result[1] === result[2] &&
      result[2] === result[3];

    const hasBanana = bananaIndices.length > 0;
    const hasNasu = nasuIndices.length > 0;

    clearEmojiRain();

    // 1. ãƒãƒŠãƒŠã‚¹ï¼ˆæœ€å¼·ï¼‰
    if (isBananas) {
      const bananasIndices = [0, 1, 2, 3];
      const basePt = 200;
      const baseBanana = 5;
      const baseNasu = 5;
      const mult = getMultiplier(multiBananasLv);
      const gainPt = Math.floor(basePt * mult);
      const gainBanana = Math.floor(baseBanana * mult);
      const gainNasu = Math.floor(baseNasu * mult);

      // è¡¨ç¤ºé †ï¼šãƒŠã‚¹ â†’ ãƒãƒŠãƒŠ â†’ ãƒãƒŠãƒŠã‚¹
      highlight(nasuIndices, "hit-nasu");
      setResult("ãƒŠã‚¹ï¼", "ğŸ†");
      startEmojiRain("nasu");
      playSound(seNasu);

      setTimeout(() => {
        highlight(bananaIndices, "hit-banana");
        setResult("ãƒãƒŠãƒŠï¼", "ğŸŒ");
        startEmojiRain("banana");
        playSound(seBanana);
      }, 700);

      setTimeout(() => {
        highlight(bananasIndices, "hit-bananas");
        setResult(`ãƒãƒŠãƒŠã‚¹ï¼ï¼ï¼ +${gainPt}pt ğŸŒx${gainBanana} ğŸ†x${gainNasu}`, "ğŸŒğŸ†");
        startEmojiRain("both");
        playSound(seBananas);
        popup.style.display = "flex";

        points += gainPt;
        bananas += gainBanana;
        eggplants += gainNasu;
        updateStatus();
      }, 1400);

    // 2. WãƒãƒŠãƒŠï¼ˆãƒãƒŠãƒŠãƒï¼‰
    } else if (isWBanana) {
      const basePt = 80;
      const baseBanana = 2;
      const mult = getMultiplier(multiWBananaLv);
      const gainPt = Math.floor(basePt * mult);
      const gainBanana = Math.floor(baseBanana * mult);

      highlight([0, 1, 2, 3], "hit-banana");
      setResult(`WãƒãƒŠãƒŠï¼ +${gainPt}pt ğŸŒx${gainBanana}`, "ğŸŒğŸŒ");
      startEmojiRain("banana");
      playSound(seBanana);

      points += gainPt;
      bananas += gainBanana;
      updateStatus();

    // 3. WãƒŠã‚¹ï¼ˆãƒŠã‚¹ãƒŠã‚¹ï¼‰
    } else if (isWNasu) {
      const basePt = 50;
      const baseNasu = 2;
      const mult = getMultiplier(multiWNasuLv);
      const gainPt = Math.floor(basePt * mult);
      const gainNasu = Math.floor(baseNasu * mult);

      highlight([0, 1, 2, 3], "hit-nasu");
      setResult(`WãƒŠã‚¹ï¼ +${gainPt}pt ğŸ†x${gainNasu}`, "ğŸ†ğŸ†");
      startEmojiRain("nasu");
      playSound(seNasu);

      points += gainPt;
      eggplants += gainNasu;
      updateStatus();

    // 4. 4æ–‡å­—åŒã˜ï¼ˆãƒãƒãƒãƒ / ãƒŠãƒŠãƒŠãƒŠ / ã‚¹ã‚¹ã‚¹ã‚¹ï¼‰
    } else if (isFourSame) {
      highlight([0, 1, 2, 3], "hit-bananas");
      setResult("4æ–‡å­—åŒã˜ï¼ ç„¡æ–™ã‚¹ãƒ”ãƒ³+5", "ğŸ");
      startEmojiRain("both");
      playSound(seBananas);

      freeSpins += 5;
      updateStatus();

    // 5. ãƒãƒŠãƒŠï¼ˆxãƒãƒŠãƒŠ / ãƒãƒŠãƒŠxï¼‰
    } else if (hasBanana) {
      const basePt = 20;
      const baseBanana = 1;
      const mult = getMultiplier(multiBananaLv);
      const gainPt = Math.floor(basePt * mult);
      const gainBanana = Math.floor(baseBanana * mult);

      highlight(bananaIndices, "hit-banana");
      setResult(`ãƒãƒŠãƒŠï¼ +${gainPt}pt ğŸŒx${gainBanana}`, "ğŸŒ");
      startEmojiRain("banana");
      playSound(seBanana);

      points += gainPt;
      bananas += gainBanana;
      updateStatus();

    // 6. ãƒŠã‚¹ï¼ˆxxãƒŠã‚¹ / xãƒŠã‚¹x / ãƒŠã‚¹xxï¼‰
    } else if (hasNasu) {
      const basePt = 10;
      const baseNasu = 1;
      const mult = getMultiplier(multiNasuLv);
      const gainPt = Math.floor(basePt * mult);
      const gainNasu = Math.floor(baseNasu * mult);

      highlight(nasuIndices, "hit-nasu");
      setResult(`ãƒŠã‚¹ï¼ +${gainPt}pt ğŸ†x${gainNasu}`, "ğŸ†");
      startEmojiRain("nasu");
      playSound(seNasu);

      points += gainPt;
      eggplants += gainNasu;
      updateStatus();

    // 7. å½¹ãªã—
    } else {
      setResult("å½¹ãªã—â€¦", "ğŸ¥²");
    }
  }

  // --- è‚²æˆãƒœã‚¿ãƒ³ã®å‡¦ç† ---

  // ğŸŒ â†’ 1ã‚¹ãƒ­ãƒƒãƒˆç›®ã€Œãƒã€ç¢ºç‡UP
  upgradeProbBBtn.addEventListener("click", () => {
    if (probBLevel >= maxProbLevel) return;
    const cost = fibCosts[probBLevel];
    if (bananas < cost) {
      setResult("ğŸŒãŒè¶³ã‚Šã¾ã›ã‚“â€¦", "ğŸŒ");
      return;
    }
    bananas -= cost;
    probBLevel++;
    setResult(`1ã‚¹ãƒ­ãƒƒãƒˆç›®ã€Œãƒã€ç¢ºç‡UP Lv.${probBLevel}`, "â¬†ï¸");
    updateStatus();
  });

  // ğŸ† â†’ 4ã‚¹ãƒ­ãƒƒãƒˆç›®ã€Œã‚¹ã€ç¢ºç‡UP
  upgradeProbSBtn.addEventListener("click", () => {
    if (probSLevel >= maxProbLevel) return;
    const cost = fibCosts[probSLevel];
    if (eggplants < cost) {
      setResult("ğŸ†ãŒè¶³ã‚Šã¾ã›ã‚“â€¦", "ğŸ†");
      return;
    }
    eggplants -= cost;
    probSLevel++;
    setResult(`4ã‚¹ãƒ­ãƒƒãƒˆç›®ã€Œã‚¹ã€ç¢ºç‡UP Lv.${probSLevel}`, "â¬†ï¸");
    updateStatus();
  });

  // å€ç‡UPï¼šãƒãƒŠãƒŠã‚¹ï¼ˆğŸŒx2f(n)ğŸ†x2f(n)ï¼‰
  upgradeMultiBananasBtn.addEventListener("click", () => {
    if (multiBananasLv >= maxMultiLevel) return;
    const f = fibCosts[multiBananasLv];
    const needBanana = 2 * f;
    const needNasu = 2 * f;
    if (bananas < needBanana || eggplants < needNasu) {
      setResult("ğŸŒã‹ğŸ†ãŒè¶³ã‚Šã¾ã›ã‚“â€¦", "âš ï¸");
      return;
    }
    bananas -= needBanana;
    eggplants -= needNasu;
    multiBananasLv++;
    setResult(
      `ãƒãƒŠãƒŠã‚¹å€ç‡UP Lv.${multiBananasLv} â†’ x${getMultiplier(multiBananasLv).toFixed(1)}`,
      "âœ¨"
    );
    updateStatus();
  });

  // å€ç‡UPï¼šWãƒãƒŠãƒŠï¼ˆğŸŒx2f(n)ï¼‰
  upgradeMultiWBananaBtn.addEventListener("click", () => {
    if (multiWBananaLv >= maxMultiLevel) return;
    const f = fibCosts[multiWBananaLv];
    const needBanana = 2 * f;
    if (bananas < needBanana) {
      setResult("ğŸŒãŒè¶³ã‚Šã¾ã›ã‚“â€¦", "ğŸŒ");
      return;
    }
    bananas -= needBanana;
    multiWBananaLv++;
    setResult(
      `WãƒãƒŠãƒŠå€ç‡UP Lv.${multiWBananaLv} â†’ x${getMultiplier(multiWBananaLv).toFixed(1)}`,
      "âœ¨"
    );
    updateStatus();
  });

  // å€ç‡UPï¼šWãƒŠã‚¹ï¼ˆğŸ†x2f(n)ï¼‰
  upgradeMultiWNasuBtn.addEventListener("click", () => {
    if (multiWNasuLv >= maxMultiLevel) return;
    const f = fibCosts[multiWNasuLv];
    const needNasu = 2 * f;
    if (eggplants < needNasu) {
      setResult("ğŸ†ãŒè¶³ã‚Šã¾ã›ã‚“â€¦", "ğŸ†");
      return;
    }
    eggplants -= needNasu;
    multiWNasuLv++;
    setResult(
      `WãƒŠã‚¹å€ç‡UP Lv.${multiWNasuLv} â†’ x${getMultiplier(multiWNasuLv).toFixed(1)}`,
      "âœ¨"
    );
    updateStatus();
  });

  // å€ç‡UPï¼šãƒãƒŠãƒŠï¼ˆğŸŒxf(n)ï¼‰
  upgradeMultiBananaBtn.addEventListener("click", () => {
    if (multiBananaLv >= maxMultiLevel) return;
    const f = fibCosts[multiBananaLv];
    const needBanana = f;
    if (bananas < needBanana) {
      setResult("ğŸŒãŒè¶³ã‚Šã¾ã›ã‚“â€¦", "ğŸŒ");
      return;
    }
    bananas -= needBanana;
    multiBananaLv++;
    setResult(
      `ãƒãƒŠãƒŠå€ç‡UP Lv.${multiBananaLv} â†’ x${getMultiplier(multiBananaLv).toFixed(1)}`,
      "âœ¨"
    );
    updateStatus();
  });

  // å€ç‡UPï¼šãƒŠã‚¹ï¼ˆğŸ†xf(n)ï¼‰
  upgradeMultiNasuBtn.addEventListener("click", () => {
    if (multiNasuLv >= maxMultiLevel) return;
    const f = fibCosts[multiNasuLv];
    const needNasu = f;
    if (eggplants < needNasu) {
      setResult("ğŸ†ãŒè¶³ã‚Šã¾ã›ã‚“â€¦", "ğŸ†");
      return;
    }
    eggplants -= needNasu;
    multiNasuLv++;
    setResult(
      `ãƒŠã‚¹å€ç‡UP Lv.${multiNasuLv} â†’ x${getMultiplier(multiNasuLv).toFixed(1)}`,
      "âœ¨"
    );
    updateStatus();
  });

  spinBtn.addEventListener("click", spin);
</script>

</body>
</html>
